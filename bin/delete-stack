#!/bin/bash

usage() {
    echo "usage: $0 [stack_name]"
    exit 0
}

log () {
    ts="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "$ts $*"
}

die () {
  echo "FATAL: $*" >&2
  exit 1
}

: "${AWS_DEFAULT_REGION?Export AWS_DEFAULT_REGION and try again}"

[[ "$#" == "1" ]] || usage

hash aws 2>/dev/null || { echo "Error: missing 'awscli' dependency."; exit 2; }

stack_name="$1"
poll_timeout=5

# NOTE: this isn't quite the same as AWS' check, but it's close
[[ "$stack_name" =~ [^-a-zA-Z0-9] ]] && die "bad stack name"

exists="0"
while read -r; do
    [[ "$REPLY" == "$stack_name" ]] && { exists="1"; break; }
done < <(aws cloudformation describe-stacks --query 'Stacks[*].[StackName]' --output text)

[[ "$exists" -gt "0" ]] || die "stack \"$stack_name\" does not exist"

log "Deleting: name=$stack_name..."
aws cloudformation delete-stack --stack-name "$stack_name"
aws cloudformation wait stack-delete-complete --stack-name "$stack_name"

action="delete"
log "Complete: name=$stack_name action=$action"
